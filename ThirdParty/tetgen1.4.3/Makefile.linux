CC=g++
LD=g++

# DEBUG = 0
# PROFILE = 0

BUILDDIR = ./build
SRCDIR = ./src
TET_DIR = ./source
INCLUDEDIR = $(TET_DIR)
BINDIR = ./bin

CPPFLAGS=-I$(INCLUDEDIR) -fPIC --std=c++11 -DPTR_EXCEEDS_LONG -DTETLIBRARY
ifdef DEBUG
CPPFLAGS:=$(CPPFLAGS) -g -O0
else
CPPFLAGS:=$(CPPFLAGS) -O3
endif

LDFLAGS=
ifdef PROFILE
CPPFLAGS:=$(CPPFLAGS) -pg
LDFLAGS:=$(LDFLAGS) -pg
endif

# Library extension
ifndef LIB_EXT
LIB_EXT:=so
endif

# Octave folders
ifndef MEX_EXT
MEX_EXT:=mex
endif
ifndef OCTAVE_INCLUDEDIR
OCTAVE_INCLUDEDIR:="/opt/octavedev/include/octave-4.1.0+/octave"
endif
ifndef OCTAVE_LIBDIR
OCTAVE_LIBDIR:="/opt/octavedev/lib/octave/4.1.0+"
endif

MEX_CPPFLAGS:=$(CPPFLAGS) -DMX_COMPAT_32 -DMATLAB_MEX_FILE -I"$(OCTAVE_INCLUDEDIR)" -Wall
MEX_LDFLAGS:= $(LDFLAGS) -shared -L"$(OCTAVE_LIBDIR)" -lstdc++ -loctinterp

MEX_SOURCES = $(SRCDIR)/tetgen_mex.cpp
MEX_OBJECTS = $(BUILDDIR)/tetgen.mexo
MEX = $(BINDIR)/tetgen.$(MEX_EXT)

MFILES := $(BINDIR)/tetgen.m
SOURCES := $(TET_DIR)/predicates.cxx $(TET_DIR)/tetgen.cxx 
OBJECTS := $(BUILDDIR)/predicates.o $(BUILDDIR)/tetgen.o

MKDIR_CMD=mkdir -p $(@D)

default: all

cleanup:
	rm -rf $(OBJECTS) $(MEX_OBJECTS)

clean: cleanup
	rm -rf $(MEX) $(MFILES)

# do not delete intermediates
.SECONDARY:

vars:
	@echo "MEX_SOURCES: $(MEX_SOURCES)"
	@echo "MEX_OBJECTS: $(MEX_OBJECTS)"
	@echo "MEX_CPPFLAGS: $(MEX_CPPFLAGS)"
	@echo "MEX_LDFLAGS: $(MEX_LDFLAGS)"
	@echo "MEX: $(MEX)"
	@echo "MFILES: $(MFILES)"
	@echo "SOURCES: $(SOURCES)"
	@echo "OBJECTS: $(OBJECTS)"
	

all: mex

mex: $(MEX) $(MFILES)

$(BUILDDIR)/%.o: $(TET_DIR)/%.cxx
	@$(MKDIR_CMD)
	@echo Compiling $@...
	@$(CC) $(CPPFLAGS) -o $@ -c $<

$(BUILDDIR)/%.mexo: $(SRCDIR)/%_mex.cpp
	@$(MKDIR_CMD)
	@echo Compiling $@...
	@$(CC) $(MEX_CPPFLAGS) -o $@ -c $<

$(BINDIR)/%.$(MEX_EXT): $(BUILDDIR)/%.mexo $(OBJECTS)
	@$(MKDIR_CMD)
	@echo Assembling $@ ...
	@$(LD) -o $@ $(MEX_LDFLAGS) $(OBJECTS) $<
	@echo Complete!
	
$(BINDIR)/%.m: $(SRCDIR)/%.m
	@$(MKDIR_CMD)
	@echo Copying $@ ...
	@cp $< $@

